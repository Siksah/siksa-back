name: Deploy React Frontend to GCP VM

# 1. ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´ ì •ì˜
on:
  push:
    branches:
      - main
      - proto
    paths:
      - '**'

  # ğŸ’¡ ìˆ˜ë™ ì‹¤í–‰(Manual Trigger) ì˜µì…˜ ì¶”ê°€ 
  workflow_dispatch: {}
      
# 2. ì‹¤í–‰ë  ì‘ì—…(Job) ì •ì˜
jobs:
  deploy:
    # ì´ ì‘ì—…ì´ ì‹¤í–‰ë  ê°€ìƒ í™˜ê²½ ì •ì˜ (GitHub Runner)
    runs-on: ubuntu-latest

    # 3. ì‘ì—…ì˜ ë‹¨ê³„(Steps) ì •ì˜
    steps:
      # Git ë ˆí¬ì§€í† ë¦¬ì˜ ì½”ë“œë¥¼ Runner í™˜ê²½ìœ¼ë¡œ ë³µì œí•©ë‹ˆë‹¤.
      - name: Checkout Code
        uses: actions/checkout@v4
        
      # 1ë‹¨ê³„: SSH í‚¤ ì„¤ì •
      # GitHub Secretì— ì €ì¥ëœ ë¹„ê³µê°œ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ VM ì ‘ì† ì¤€ë¹„ë¥¼ í•©ë‹ˆë‹¤.
      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          # SSH_PRIVATE_KEY Secret (ê°œì¸ í‚¤ íŒŒì¼ ë‚´ìš©) ì‚¬ìš©
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 2ë‹¨ê³„: SSHë¥¼ í†µí•´ VMìœ¼ë¡œ íŒŒì¼ ì „ì†¡ (rsync ì‚¬ìš©)
      - name: Transfer Files to VM
        run: |
          # SSH ì ‘ì† ì‹œ ë³´ì•ˆ ê²½ê³ ë¥¼ ë¬´ì‹œí•˜ë„ë¡ VM_HOST_IPë¥¼ known_hostsì— ë“±ë¡
          ssh-keyscan -H ${{ secrets.VM_HOST_IP }} >> ~/.ssh/known_hosts
          
          # rsync ëª…ë ¹ìœ¼ë¡œ Runnerì˜ ì½”ë“œë¥¼ VMì˜ ëª©í‘œ ë””ë ‰í† ë¦¬ë¡œ ë™ê¸°í™”í•©ë‹ˆë‹¤.
          rsync -avz --delete --exclude 'node_modules' --exclude 'dist' ./ ${{ secrets.VM_USER }}@${{ secrets.VM_HOST_IP }}:${{ secrets.VM_TARGET_DIR }}
        
      # 3ë‹¨ê³„: SSHë¥¼ í†µí•´ Docker Compose ëª…ë ¹ ì‹¤í–‰
      # appleboy/ssh-action ì•¡ì…˜ì„ ì‚¬ìš©í•˜ì—¬ VMì—ì„œ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
      - name: Deploy and Restart Backend/Frontend Containers
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST_IP }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # -----------------------------------------------
          # âš ï¸ ìˆ˜ì •ëœ ìŠ¤í¬ë¦½íŠ¸ ë‚´ìš©
          script: |
            echo "--- Navigating to deployment directory (Project Root) ---"
            # docker-compose.ymlì´ ìœ„ì¹˜í•œ í”„ë¡œì íŠ¸ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd ${{ secrets.VM_TARGET_DIR }} 
            cd ..

            # ========== ë°±ì—”ë“œ (NestJS) ë°°í¬ ì‹œì‘ ==========
            
            # 1. Backend ì´ë¯¸ì§€ ë¹Œë“œ (siksa-backend-app)
            echo "--- Building Backend Production Code (siksa-backend-app) ---"
            /usr/local/bin/docker-compose build siksa-backend-app
            
            # 2. Backend ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
            echo "--- Restarting Backend Container ---"
            # ìƒˆë¡œ ë¹Œë“œëœ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ì»¨í…Œì´ë„ˆ ê°•ì œ ì¬ì‹œì‘
            /usr/local/bin/docker-compose up -d --force-recreate siksa-backend-app
            
            # ========== í”„ë¡ íŠ¸ì—”ë“œ (React) ë°°í¬ ì‹œì‘ ==========
            
            # 3. Frontend ì´ë¯¸ì§€ ë¹Œë“œ (API URL ì¸ì ì „ë‹¬)
            echo "--- Building new Frontend image (frontend-app) ---"
            /usr/local/bin/docker-compose build --no-cache \
              --build-arg VITE_API_BASE_URL="${{ secrets.VITE_FRONTEND_API_BASE_URL }}" frontend-app
              
            # 4. Frontend ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
            echo "--- Restarting Frontend Container ---"
            # ë°±ì—”ë“œì— ì˜ì¡´í•˜ì§€ë§Œ, ì´ë¯¸ ë°±ì—”ë“œê°€ ì¬ì‹œì‘ë˜ì—ˆìœ¼ë¯€ë¡œ --no-depsëŠ” ìœ ì§€
            /usr/local/bin/docker-compose up -d --no-deps --force-recreate frontend-app
            
            echo "--- Deployment complete on ${{ secrets.VM_HOST_IP }} ---"
          # -----------------------------------------------
