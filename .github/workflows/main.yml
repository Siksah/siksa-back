name: Deploy GCP VM
run-name: "[${{ github.ref_name }}] [${{ github.event.head_commit.message }}] [${{ github.actor }}]"

on:
  push:
    branches:
      - '**'

  # ğŸ’¡ ìˆ˜ë™ ì‹¤í–‰(Manual Trigger) ì˜µì…˜ ì¶”ê°€ 
  workflow_dispatch:
    inputs:
      commit_message:
        description: 'ì„ì˜ ì»¤ë°‹ ë©”ì‹œì§€'
        required: true
        default: 'Manual deploy' # ì…ë ¥ì´ ì—†ì„ ê²½ìš° ê¸°ë³¸ê°’
      
jobs:
  deploy:
    # ì´ ì‘ì—…ì´ ì‹¤í–‰ë  ê°€ìƒ í™˜ê²½ ì •ì˜ (GitHub Runner)
    runs-on: ubuntu-latest
    steps:
      # Git ë ˆí¬ì§€í† ë¦¬ì˜ ì½”ë“œë¥¼ Runner í™˜ê²½ìœ¼ë¡œ ë³µì œ
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. GCP ì¸ì¦ (Secretsì— ë“±ë¡í•œ JSON í‚¤ ì‚¬ìš©)
      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # 3. gcloud SDK ì„¤ì •
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      # 4. Artifact Registry ì¸ì¦ (Docker ë¡œê·¸ì¸ ëŒ€ì²´)
      - name: 'Docker Auth'
        run: |-
          gcloud auth configure-docker asia-northeast1-docker.pkg.dev

      # 5. ë¹Œë“œ ë° Artifact Registryë¡œ í‘¸ì‹œ
      # ê¸°ì¡´ Docker Hub ë‹¨ê³„ëŠ” ì œê±°í•˜ê³  GCP ì €ì¥ì†Œë¡œ ì§ì ‘ ë¹Œë“œ/í‘¸ì‹œí•©ë‹ˆë‹¤.
      - name: Build and Push to Artifact Registry
        run: |
          docker build -t asia-northeast1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/siksa/siksa-backend-app:latest -f ./dockerfiles/backend.Dockerfile .
          docker push asia-northeast1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/siksa/siksa-backend-app:latest

      # 6. Cloud Run ì„œë¹„ìŠ¤ ë°°í¬
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy siksa-backend \
            --image asia-northeast1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/siksa/siksa-backend-app:latest \
            --region asia-northeast1 \
            --platform managed \
            --allow-unauthenticated \
            --port 8080